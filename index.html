<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create A Dino</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Creepster&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Orbitron', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a4d3a 50%, #0d2818 100%);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        .stars {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 2s infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 1; }
        }

        .menu-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: radial-gradient(circle at center, rgba(26, 77, 58, 0.3) 0%, transparent 70%);
        }

        .game-title {
            font-family: 'Creepster', cursive;
            font-size: clamp(3rem, 8vw, 6rem);
            color: #4ade80;
            text-shadow: 0 0 20px #4ade80, 0 0 40px #4ade80, 0 0 60px #4ade80;
            margin-bottom: 2rem;
            animation: glow 2s ease-in-out infinite alternate;
        }

        @keyframes glow {
            from { text-shadow: 0 0 20px #4ade80, 0 0 40px #4ade80, 0 0 60px #4ade80; }
            to { text-shadow: 0 0 30px #4ade80, 0 0 60px #4ade80, 0 0 90px #4ade80; }
        }

        .menu-button {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            margin: 10px;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
            font-family: 'Orbitron', monospace;
        }

        .menu-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.5);
        }

        .menu-button:active {
            transform: translateY(0);
        }

        .game-interface {
            display: none;
            min-height: 100vh;
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 30%, #15803d 100%);
            position: relative;
            overflow: hidden;
            padding-top: 80px;
        }

        .grass-pattern {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 80%, rgba(21, 128, 61, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(34, 197, 94, 0.3) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(22, 163, 74, 0.2) 0%, transparent 50%);
            z-index: -1;
        }

        .incubators-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            padding: 20px;
            max-width: 600px;
            margin: 0 auto;
        }

        .incubator {
            background: linear-gradient(135deg, #8b4513 0%, #654321 100%);
            border: 3px solid #654321;
            border-radius: 15px;
            aspect-ratio: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.3), 0 4px 10px rgba(0,0,0,0.2);
            position: relative;
            overflow: hidden;
        }

        .incubator.selected {
            border-color: white;
            box-shadow: 0 0 20px rgba(255,255,255,0.5);
        }

        .incubator.occupied {
            cursor: not-allowed;
        }

        .egg {
            width: 60px;
            height: 75px;
            border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;
            position: relative;
            margin-bottom: 10px;
            animation: subtle-bounce 3s ease-in-out infinite;
        }

        .egg.common { background: linear-gradient(135deg, #f8f8f8 0%, #e0e0e0 100%); box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        .egg.golden { background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%); box-shadow: 0 4px 8px rgba(255,215,0,0.5); }
        .egg.giant { transform: scale(1.2); background: linear-gradient(135deg, #f0f0f0 0%, #d0d0d0 100%); }
        .egg.colorful { background: linear-gradient(135deg, #ff6b6b 0%, #4ecdc4 25%, #45b7d1 50%, #f9ca24 75%, #f0932b 100%); animation: color-shift 2s ease-in-out infinite; }
        .egg.diamond { background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 50%, #90caf9 100%); box-shadow: 0 0 20px rgba(144,202,249,0.8); }
        .egg.ruby { background: linear-gradient(135deg, #e91e63 0%, #ad1457 100%); box-shadow: 0 0 25px rgba(233,30,99,0.8); }

        @keyframes subtle-bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        @keyframes color-shift {
            0% { filter: hue-rotate(0deg); }
            100% { filter: hue-rotate(360deg); }
        }

        .egg-info {
            text-align: center;
            color: #000;
            font-size: 0.7rem;
            font-weight: bold;
        }
        
        .money-display {
            background: rgba(0,0,0,0.8);
            color: #4ade80;
            padding: 10px 20px;
            border-radius: 25px;
            font-size: 1.2rem;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            margin: 20px auto 0;
            width: fit-content;
            text-align: center;
        }

        .game-buttons {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 15px;
            z-index: 1000;
        }

        .side-buttons {
            position: fixed;
            right: 20px;
            top: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 1000;
        }
        
        .top-buttons {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
        }

        .action-button {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Orbitron', monospace;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        .buy-btn { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; }
        .sell-btn { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; }
        .stats-btn { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .inventory-btn { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }
        .codes-btn { background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; }

        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 2000;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #1f2937 0%, #374151 100%);
            border-radius: 20px;
            padding: 30px;
            max-width: 90vw;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.5);
        }

        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 1.2rem;
        }

        .shop-content {
            background: linear-gradient(135deg, #065f46 0%, #047857 100%);
        }

        .shop-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin: 10px 0;
            background: rgba(255,255,255,0.1);
            border-radius: 10px;
            color: white;
        }

        .shop-item.out-of-stock {
            background: rgba(239,68,68,0.2);
            color: #ef4444;
        }

        .shop-item.out-of-stock .shop-buy-btn {
            background: #6b7280;
            cursor: not-allowed;
        }

        .shop-buy-btn {
            background: #22c55e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
        }

        .inventory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .dino-card {
            background: linear-gradient(135deg, #4f46e5 0%, #3730a3 100%);
            color: white;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .dino-card:hover { transform: scale(1.05); }

        .dino-card.selected {
            border: 3px solid #fbbf24;
            box-shadow: 0 0 20px rgba(251,191,36,0.5);
        }

        .how-to-play { color: white; line-height: 1.6; }
        .how-to-play h2 { color: #4ade80; margin-bottom: 15px; }

        .code-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #4ade80;
            border-radius: 10px;
            background: rgba(255,255,255,0.1);
            color: white;
            font-size: 1rem;
            margin-bottom: 15px;
        }

        .code-submit {
            background: linear-gradient(135deg, #4ade80 0%, #22c55e 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-weight: bold;
        }

        .notification.show { opacity: 1; }
        .notification.error { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

        @media (max-width: 768px) {
            .game-interface { padding-top: 100px; }
            .game-buttons { flex-direction: column; bottom: 10px; left: auto; right: 10px; transform: none; }
            .side-buttons { right: 10px; top: 80px; transform: none; }
            .modal-content { padding: 20px; max-width: 95vw; }
        }
    </style>
</head>
<body>
    <div class="stars" id="stars"></div>
    
    <div class="menu-container" id="menuContainer" style="display: none;">
        <h1 class="game-title">CREATE A DINO</h1>
        <button class="menu-button" onclick="showLoginScreen()">TROCAR DE CONTA</button>
        <button class="menu-button" onclick="showHowToPlay()">COMO JOGAR</button>
    </div>

    <div class="game-interface" id="gameInterface">
        <div class="grass-pattern"></div>
        
        <div class="top-buttons">
            <button class="action-button inventory-btn" onclick="showInventory()">üì¶ INVENT√ÅRIO</button>
        </div>
        
        <div class="side-buttons">
            <button class="action-button codes-btn" onclick="showCodes()">üîë C√ìDIGOS</button>
        </div>
        
        <div class="incubators-container" id="incubatorsContainer">
            </div>
        
        <div class="money-display">
            üí∞ $<span id="money">500</span>
        </div>
        
        <div class="game-buttons" id="mainGameButtons">
            <button class="action-button buy-btn" onclick="showShop()">üõí COMPRAR</button>
            <button class="action-button stats-btn" onclick="showStats()">üìä ESTAT√çSTICAS</button>
            <button class="action-button sell-btn" onclick="showSellInterface()">üí∞ VENDER</button>
            <button class="action-button" style="background: linear-gradient(135deg, #b91c1c 0%, #7f1d1d 100%);" onclick="showRobberyPrompt()">‚öîÔ∏è ROUBAR</button>
        </div>

        <div class="game-buttons" id="robberyActionButtons" style="display: none;">
            <button id="startRobberyBtn" class="action-button" style="background: #111;">INICIAR ROUBO</button>
        </div>
        <button id="robberyExitButton" class="close-btn" style="display: none; position: fixed; top: 20px; right: 20px;" onclick="exitRobberyMode()">X</button>
    </div>

    <div class="modal" id="howToPlayModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('howToPlayModal')">√ó</button>
            <div class="how-to-play">
                <h2>ü¶ï COMO JOGAR</h2>
                <p><strong>Objetivo:</strong> Colecione, incube e venda dinossauros para construir seu imp√©rio pr√©-hist√≥rico!</p>
                <br>
                <p><strong>Roubo:</strong> Voc√™ pode tentar roubar dinossauros de outros jogadores, mas cuidado! Eles podem se defender. Proteja seu jardim com itens de seguran√ßa da loja.</p>
                <br>
                <p><strong>Muta√ß√µes Raras:</strong></p>
                <p>‚Ä¢ Dourado: +5% valor, +3% tempo</p>
                <p>‚Ä¢ Gigante: +10% peso, +8% tamanho</p>
                <p>‚Ä¢ Colorido: +15% valor, -vida</p>
                <p>‚Ä¢ Diamante: +30% valor, +vida</p>
                <p>‚Ä¢ Rubi: +113% valor, +260% vida</p>
            </div>
        </div>
    </div>

    <div class="modal" id="shopModal">
        <div class="modal-content shop-content">
            <button class="close-btn" onclick="closeModal('shopModal')">√ó</button>
            <h2 style="color: white; margin-bottom: 10px;">üõí LOJA</h2>
            <div id="shopTimer" style="color: #fbbf24; text-align: center; margin-bottom: 15px; font-size: 1.1rem;"></div>
            <div id="shopItems"></div>
            <hr style="margin: 20px 0; border-color: rgba(255,255,255,0.2);">
            <div id="securityItems"></div>
        </div>
    </div>

    <div class="modal" id="inventoryModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('inventoryModal')">√ó</button>
            <h2 style="color: white; margin-bottom: 20px;">üì¶ INVENT√ÅRIO</h2>
            <div class="inventory-grid" id="inventoryGrid"></div>
        </div>
    </div>

    <div class="modal" id="statsModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('statsModal')">√ó</button>
            <h2 style="color: white; margin-bottom: 20px;">üìä ESTAT√çSTICAS</h2>
            <div id="statsContent" style="color: white;"></div>
        </div>
    </div>

    <div class="modal" id="codesModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('codesModal')">√ó</button>
            <h2 style="color: white; margin-bottom: 20px;">üîë C√ìDIGOS</h2>
            <input type="text" class="code-input" id="codeInput" placeholder="Digite seu c√≥digo aqui...">
            <button class="code-submit" onclick="submitCode()">USAR C√ìDIGO</button>
        </div>
    </div>

    <div class="modal" id="sellModal">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal('sellModal')">√ó</button>
            <h2 style="color: white; margin-bottom: 20px;">üí∞ VENDER DINOSSAUROS</h2>
            <div style="margin-bottom: 20px;">
                <button class="action-button sell-btn" onclick="sellRandom()">üé≤ VENDER ALEAT√ìRIO</button>
                <button class="action-button sell-btn" onclick="sellAll()">üóëÔ∏è VENDER TODOS</button>
                <button class="action-button sell-btn" onclick="sellSelected()">‚úÖ VENDER SELECIONADO</button>
            </div>
            <div class="inventory-grid" id="sellInventoryGrid"></div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // =========================================================================
// BANCO DE DADOS E ESTADO DO JOGO (SIMULADO COM LOCALSTORAGE)
// =========================================================================

let gameState = {}; // O estado do jogo ser√° carregado ap√≥s o login
let currentUser = null; // Guarda o nome do usu√°rio logado
let shopTimerInterval = null;
let gameLoopInterval = null; // Loop principal do jogo para checar boosts e roubos

// Valores padr√£o para uma nova conta
const defaultGameState = {
    money: 500,
    incubators: [null, null, null, null, null, null],
    inventory: [],
    selectedIncubator: -1,
    selectedDino: -1,
    lastStockUpdate: 0,
    usedCodes: [],
    lastExitTime: Date.now(),
    firstLoad: true,
    activeBoosts: {}, // Para 'Flash', 'Bloqueador', etc.
    cooldowns: {}, // Para roubo e itens de seguran√ßa
    robberyStatus: {
        isRobbing: null, // { target: 'nome', item: {...}, endTime: timestamp }
        beingRobbed: null, // { robber: 'nome', item: {...}, endTime: timestamp }
    }
};

// =========================================================================
// DINOSSAUROS E ITENS
// =========================================================================

const dinosaurs = {
    'Compsognato': { price: 300, time: 300000, size: 'pequeno' }, // 5 min
    'Microraptor': { price: 1500, time: 900000, size: 'pequeno' }, // 15 min
    'Velociraptor': { price: 50000, time: 3600000, size: 'm√©dio' }, // 1h
    'Indoraptor': { price: 20000, time: 1800000, size: 'pequeno' }, // 30 min
    'Estegossauro': { price: 20000, time: 2700000, size: 'pequeno' }, // 45 min
    'Indominus Rex': { price: 50000, time: 3600000, size: 'm√©dio' }, // 1h
    'Pyroraptor': { price: 52000, time: 3900000, size: 'm√©dio' }, // 1h 5min
    'Megalossauro': { price: 64000, time: 4500000, size: 'm√©dio' }, // 1h 15min
    'Triceratops': { price: 76000, time: 5400000, size: 'm√©dio' }, // 1h 30min
    'Uhtraraptor': { price: 99000, time: 6300000, size: 'm√©dio' }, // 1h 45min
    'Parassaurolofo': { price: 200000, time: 7200000, size: 'm√©dio' }, // 2h
    'Carnotauro': { price: 288537, time: 8100000, size: 'grande' }, // 2h 15min
    'Anquilossauro': { price: 296285, time: 8700000, size: 'grande' }, // 2h 25min
    'Sinoceratops': { price: 300000, time: 9000000, size: 'grande' }, // 2h 30min
    'Paquicefalossauro': { price: 325000, time: 9900000, size: 'grande' }, // 2h 45min
    'Giganotossauro': { price: 400000, time: 10800000, size: 'grande' }, // 3h
    'Braquiossauro': { price: 450000, time: 11700000, size: 'grande' }, // 3h 15min
    'Diplodoco': { price: 480000, time: 12600000, size: 'grande' }, // 3h 30min
    'Majungassauro': { price: 495000, time: 13500000, size: 'grande' }, // 3h 45min
    'Brontossauro': { price: 500000, time: 13800000, size: 'grande' }, // 3h 50min
    'Tiranossauro Rex': { price: 500000, time: 13800000, size: 'grande' }, // 3h 50min
    'Espinossauro': { price: 950500, time: 13800000, size: 'grande' } // 3h 50min
};

const securityItems = {
    'Bloqueador': {
        price: 3000,
        dinoCost: null,
        description: 'Bloqueia qualquer invas√£o ao seu jardim por 1 hora. Cooldown de 1 hora.'
    },
    'Demora': {
        price: 5000,
        dinoCost: { name: 'Triceratops', count: 1 },
        description: 'Aumenta em 10x o tempo que um jogador leva para te roubar. Dura 1 hora. Cooldown de 2 horas.'
    },
    'Falso': {
        price: 15000,
        dinoCost: { name: 'Triceratops', count: 2 },
        description: 'O ladr√£o rouba um Compsognato em vez do seu item. Dura 5 horas. Cooldown de 1 dia.'
    }
};

let currentStock = [];
let stockBoosts = {
    pequeno: 0,
    m√©dio: 0,
    grande: 0
};

// =========================================================================
// INICIALIZA√á√ÉO E L√ìGICA DE LOGIN
// =========================================================================

// Fun√ß√£o executada ao carregar a p√°gina
window.addEventListener('load', () => {
    createStars();
    // Em vez de 'init()', agora mostramos a tela de login.
    showLoginScreen(); 
});

function showLoginScreen() {
    // Esconde o jogo e o menu, mostra a tela de login
    document.getElementById('menuContainer').style.display = 'none';
    document.getElementById('gameInterface').style.display = 'none';

    // Cria a tela de login dinamicamente se n√£o existir
    if (!document.getElementById('loginScreen')) {
        const loginScreen = document.createElement('div');
        loginScreen.id = 'loginScreen';
        loginScreen.className = 'menu-container'; // Reutiliza o estilo do menu
        loginScreen.innerHTML = `
            <h2 class="game-title" style="font-size: 3rem;">Acessar Conta</h2>
            <input type="text" id="usernameInput" class="code-input" placeholder="Nome de Usu√°rio" style="margin-bottom: 10px;">
            <input type="password" id="accessCodeInput" class="code-input" placeholder="C√≥digo de Acesso">
            <button class="menu-button" onclick="handleLogin()">ENTRAR</button>
        `;
        document.body.appendChild(loginScreen);
    }
    document.getElementById('loginScreen').style.display = 'flex';
}

function handleLogin() {
    const username = document.getElementById('usernameInput').value.trim();
    const accessCode = document.getElementById('accessCodeInput').value.trim();

    if (!username || !accessCode) {
        showNotification("Preencha todos os campos!", "error");
        return;
    }

    // Pega o banco de dados de usu√°rios do localStorage
    let users = JSON.parse(localStorage.getItem('game_users')) || {};

    if (users[username]) {
        // Usu√°rio existe, checa o c√≥digo de acesso
        if (users[username] === accessCode) {
            // Login bem-sucedido
            currentUser = username;
            initGameForUser();
        } else {
            showNotification("C√≥digo de acesso incorreto!", "error");
        }
    } else {
        // Novo usu√°rio, cria a conta
        users[username] = accessCode;
        localStorage.setItem('game_users', JSON.stringify(users));
        
        // Cria um novo save para este usu√°rio
        currentUser = username;
        gameState = JSON.parse(JSON.stringify(defaultGameState)); // Cria uma c√≥pia profunda
        gameState.username = username;
        saveGameData();

        showNotification(`Conta '${username}' criada com sucesso!`, 'success');
        initGameForUser();
    }
}

function initGameForUser() {
    // Esconde a tela de login e mostra a interface do jogo
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('gameInterface').style.display = 'block';

    // Carrega os dados do usu√°rio logado
    loadGameData();
    
    // Inicia os loops do jogo
    updateStockIfNeeded();
    updateIncubators();
    
    if (gameLoopInterval) clearInterval(gameLoopInterval);
    gameLoopInterval = setInterval(gameTick, 1000); // Roda a cada segundo

    // Salvar estado periodicamente
    setInterval(saveGameData, 10000);
    window.addEventListener('beforeunload', saveGameData);
}

// Loop principal do jogo para checagens constantes
function gameTick() {
    updateIncubators();
    checkActiveBoosts();
    checkRobberyStatus();
}

// =========================================================================
// GERENCIAMENTO DE DADOS (SAVE/LOAD)
// =========================================================================

function saveGameData() {
    if (!currentUser) return;
    gameState.lastExitTime = Date.now();
    localStorage.setItem(`game_save_${currentUser}`, JSON.stringify(gameState));
}

function loadGameData() {
    if (!currentUser) return;
    const savedData = localStorage.getItem(`game_save_${currentUser}`);

    if (savedData) {
        gameState = JSON.parse(savedData);
        // Aplica o progresso offline
        const offlineTime = Date.now() - gameState.lastExitTime;

        gameState.incubators.forEach((egg, i) => {
            if (egg) {
                const effectiveStartTime = egg.startTime - offlineTime;
                if ((Date.now() - effectiveStartTime) >= egg.hatchTime) {
                    hatchDinosaur(i);
                } else {
                    egg.startTime -= offlineTime;
                }
            }
        });
    } else {
        // Isso n√£o deveria acontecer se o login funcionar, mas √© uma seguran√ßa
        gameState = JSON.parse(JSON.stringify(defaultGameState));
        gameState.username = currentUser;
    }
    updateMoneyDisplay();
}

// Fun√ß√£o para carregar os dados de OUTRO jogador (para roubo)
function loadTargetData(targetUsername) {
    const savedData = localStorage.getItem(`game_save_${targetUsername}`);
    if (savedData) {
        return JSON.parse(savedData);
    }
    return null;
}

// Fun√ß√£o para salvar os dados de OUTRO jogador (ap√≥s um roubo)
function saveTargetData(targetUsername, targetGameState) {
    localStorage.setItem(`game_save_${targetUsername}`, JSON.stringify(targetGameState));
}


// =========================================================================
// FUN√á√ïES PRINCIPAIS DO JOGO (J√Å EXISTENTES, ALGUMAS MODIFICADAS)
// =========================================================================

// ... (todas as suas fun√ß√µes de createStars, updateMoneyDisplay, etc. v√™m aqui)
// ... (vou colocar as fun√ß√µes modificadas e as novas)

function createStars() {
    const starsContainer = document.getElementById('stars');
    if(starsContainer.children.length > 0) return; // N√£o recriar estrelas
    for (let i = 0; i < 100; i++) {
        const star = document.createElement('div');
        star.className = 'star';
        star.style.left = Math.random() * 100 + '%';
        star.style.top = Math.random() * 100 + '%';
        star.style.width = Math.random() * 3 + 1 + 'px';
        star.style.height = star.style.width;
        star.style.animationDelay = Math.random() * 2 + 's';
        starsContainer.appendChild(star);
    }
}

function showHowToPlay() {
    document.getElementById('howToPlayModal').style.display = 'block';
}

function updateMoneyDisplay() {
    document.getElementById('money').textContent = gameState.money.toLocaleString();
}

function selectIncubator(index) {
    // Modificado para n√£o funcionar no modo roubo
    if (document.body.classList.contains('robbery-mode')) return;
    
    if (gameState.incubators[index] !== null) return;
    
    document.querySelectorAll('.incubator').forEach(inc => inc.classList.remove('selected'));
    gameState.selectedIncubator = index;
    document.querySelectorAll('.incubator')[index].classList.add('selected');
}


function updateStockIfNeeded() {
    const now = Date.now();
    const STOCK_DURATION = 600000; // 10 minutos
    if (now - gameState.lastStockUpdate >= STOCK_DURATION) {
        generateStock();
        gameState.lastStockUpdate = now;
    }
}

function generateStock() {
    const dinoNames = Object.keys(dinosaurs);
    const stockSize = Math.floor(Math.random() * (dinoNames.length - 2)) + 2;
    
    currentStock = [];
    const shuffled = [...dinoNames].sort(() => 0.5 - Math.random());
    
    for (let i = 0; i < stockSize; i++) {
        const dino = shuffled[i];
        const baseChance = dinosaurs[dino].price > 300000 ? 0.3 : 
                         dinosaurs[dino].price > 100000 ? 0.6 : 0.8;
        
        const boost = stockBoosts[dinosaurs[dino].size];
        const chance = Math.min(baseChance + boost, 0.9);
        
        if (Math.random() < chance) {
            currentStock.push(dino);
        }
    }
    
    if (gameState.firstLoad) {
        if (!currentStock.includes('Compsognato')) {
            currentStock.unshift('Compsognato');
        }
        gameState.firstLoad = false;
    }
    
    if (currentStock.length === 0) {
        currentStock.push(shuffled[0]);
    }
}


function showShop() {
    updateStockIfNeeded();
    const shopItems = document.getElementById('shopItems');
    const securityItemsContainer = document.getElementById('securityItems');
    shopItems.innerHTML = '<h3>Dinossauros</h3>';
    securityItemsContainer.innerHTML = '<h3>Seguran√ßa</h3>';
    
    // Popula loja de dinos
    Object.keys(dinosaurs).forEach(dino => {
        const item = document.createElement('div');
        const inStock = currentStock.includes(dino);
        item.className = `shop-item ${inStock ? '' : 'out-of-stock'}`;
        item.innerHTML = `
            <div>
                <div style="font-weight: bold; font-size: 1.1rem;">${dino}</div>
                <div>$${dinosaurs[dino].price.toLocaleString()}</div>
            </div>
            <button class="shop-buy-btn" onclick="buyDino('${dino}')" 
                    ${inStock ? '' : 'disabled'}>
                ${inStock ? 'COMPRAR' : 'FORA DE ESTOQUE'}
            </button>
        `;
        shopItems.appendChild(item);
    });

    // Popula loja de seguran√ßa
    Object.keys(securityItems).forEach(secItemName => {
        const secItem = securityItems[secItemName];
        const item = document.createElement('div');
        item.className = 'shop-item';
        let costString = `$${secItem.price.toLocaleString()}`;
        if (secItem.dinoCost) {
            costString += ` + ${secItem.dinoCost.count} ${secItem.dinoCost.name}(s)`;
        }
        item.innerHTML = `
            <div>
                <div style="font-weight: bold; font-size: 1.1rem;">${secItemName}</div>
                <div style="font-size: 0.8rem; opacity: 0.8;">${secItem.description}</div>
                <div>Custo: ${costString}</div>
            </div>
            <button class="shop-buy-btn" onclick="buySecurityItem('${secItemName}')">COMPRAR</button>
        `;
        securityItemsContainer.appendChild(item);
    });
    
    startShopTimer();
    document.getElementById('shopModal').style.display = 'block';
}

function startShopTimer() {
    if (shopTimerInterval) clearInterval(shopTimerInterval);

    const timerElement = document.getElementById('shopTimer');
    const STOCK_DURATION = 600000;

    shopTimerInterval = setInterval(() => {
        const now = Date.now();
        const timePassed = now - gameState.lastStockUpdate;
        const timeRemaining = STOCK_DURATION - timePassed;

        if (timeRemaining <= 0) {
            timerElement.innerHTML = 'Reabastecendo estoque...';
        } else {
            const minutes = Math.floor(timeRemaining / 60000);
            const seconds = Math.floor((timeRemaining % 60000) / 1000);
            timerElement.innerHTML = `Pr√≥ximo estoque em: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
    }, 1000);
}

function buyDino(dinoName) {
    if (!currentStock.includes(dinoName)) {
        showNotification('Dinossauro fora de estoque!', 'error');
        return;
    }
    const price = dinosaurs[dinoName].price;
    if (gameState.money < price) {
        showNotification('Dinheiro insuficiente!', 'error');
        return;
    }
    if (gameState.selectedIncubator === -1) {
        showNotification('Selecione um incubador primeiro!', 'error');
        return;
    }
    if (gameState.incubators[gameState.selectedIncubator] !== null) {
        showNotification('Incubador j√° est√° ocupado!', 'error');
        return;
    }
    
    gameState.money -= price;
    updateMoneyDisplay();
    
    const mutations = [];
    if (Math.random() < 0.25) mutations.push('golden');
    if (Math.random() < 0.10) mutations.push('giant');
    if (Math.random() < 0.07) mutations.push('colorful');
    if (Math.random() < 0.05) mutations.push('diamond');
    if (Math.random() < 0.03) mutations.push('ruby');
    
    const egg = {
        dino: dinoName,
        mutations: mutations,
        startTime: Date.now(),
        hatchTime: calculateHatchTime(dinoName, mutations)
    };
    
    gameState.incubators[gameState.selectedIncubator] = egg;
    gameState.selectedIncubator = -1;
    
    document.querySelectorAll('.incubator').forEach(inc => inc.classList.remove('selected'));
    
    updateIncubators();
    closeModal('shopModal');
    showNotification(`${dinoName} comprado com sucesso!`);
}

function calculateHatchTime(dinoName, mutations) {
    let baseTime = dinosaurs[dinoName].time;
    // Boost de velocidade do c√≥digo 'Flash'
    if (gameState.activeBoosts.speed && Date.now() < gameState.activeBoosts.speed.expires) {
        baseTime /= 2;
    }
    mutations.forEach(mutation => {
        switch(mutation) {
            case 'golden': baseTime *= 1.03; break;
            case 'giant': baseTime *= 1.08; break;
            case 'diamond': baseTime *= 1.15; break;
            case 'ruby': baseTime *= 1.30; break;
        }
    });
    return baseTime;
}


function updateIncubators(targetData = null) {
    const data = targetData || gameState;
    const incubatorsContainer = document.getElementById('incubatorsContainer');
    incubatorsContainer.innerHTML = ''; // Limpa para redesenhar

    for (let i = 0; i < 6; i++) {
        const incubatorDiv = document.createElement('div');
        incubatorDiv.className = 'incubator';
        
        const egg = data.incubators[i];
        
        if (egg === null) {
            incubatorDiv.innerHTML = '';
            incubatorDiv.classList.remove('occupied');
        } else {
            incubatorDiv.classList.add('occupied');
            
            const remaining = Math.max(0, egg.hatchTime - (Date.now() - egg.startTime));
            
            if (!targetData && remaining <= 0) {
                hatchDinosaur(i);
                continue; // Pula para o pr√≥ximo loop
            }

            const hours = Math.floor(remaining / 3600000);
            const minutes = Math.floor((remaining % 3600000) / 60000);
            const seconds = Math.floor((remaining % 60000) / 1000);
            const mutationClass = egg.mutations.length > 0 ? egg.mutations[0] : 'common';
            
            incubatorDiv.innerHTML = `
                <div class="egg ${mutationClass}"></div>
                <div class="egg-info">
                    <div>${egg.dino}</div>
                    <div>${hours}h ${minutes}m ${seconds}s</div>
                </div>
            `;
        }
        incubatorDiv.onclick = () => {
             if (document.body.classList.contains('robbery-mode')) {
                 selectItemToSteal({type: 'egg', index: i, data: egg}, incubatorDiv);
             } else {
                 selectIncubator(i);
             }
        };
        incubatorsContainer.appendChild(incubatorDiv);
    }
}


function hatchDinosaur(incubatorIndex) {
    const egg = gameState.incubators[incubatorIndex];
    if (!egg) return;

    const dino = createDinoObject(egg.dino, egg.mutations);
    
    gameState.inventory.push(dino);
    gameState.incubators[incubatorIndex] = null;
    
    showNotification(`${egg.dino} nasceu! ü¶ï`);
    updateIncubators();
}

function createDinoObject(dinoName, mutations = [], customData = {}) {
     const dino = {
        name: dinoName,
        customName: customData.customName || dinoName,
        mutations: mutations,
        age: 0,
        weight: generateWeight(dinoName, mutations),
        size: generateSize(dinoName, mutations),
        lifeExpectancy: generateLifeExpectancy(dinoName, mutations),
        value: calculateValue(dinoName, mutations, customData.valueMultiplier),
        appearance: generateAppearance(mutations),
        birthTime: Date.now(),
        isSpecial: !!customData.isSpecial
    };
    return dino;
}

// ... (fun√ß√µes generateWeight, generateSize, generateLifeExpectancy, etc. inalteradas)
function generateWeight(dinoName, mutations) {
    const baseWeights = {
        'Compsognato': 2.5, 'Microraptor': 1, 'Indoraptor': 300, 'Estegossauro': 2000,
        'Indominus Rex': 4000, 'Velociraptor': 20, 'Pyroraptor': 25, 'Megalossauro': 1000,
        'Triceratops': 6000, 'Uhtraraptor': 500, 'Parassaurolofo': 2500, 'Carnotauro': 1500,
        'Anquilossauro': 6000, 'Sinoceratops': 4000, 'Paquicefalossauro': 400, 'Giganotossauro': 8000,
        'Braquiossauro': 50000, 'Diplodoco': 15000, 'Majungassauro': 1500, 'Brontossauro': 15000,
        'Tiranossauro Rex': 7000, 'Espinossauro': 10000
    };
    let weight = baseWeights[dinoName] || 1000;
    weight += (Math.random() - 0.5) * weight * 0.2;
    mutations.forEach(m => {
        if (m === 'golden') weight *= 1.05;
        if (m === 'giant') weight *= 1.10;
    });
    return Math.round(weight * 100) / 100;
}
function generateSize(dinoName, mutations) {
    const baseSizes = {
        'Compsognato': 1, 'Microraptor': 0.6, 'Indoraptor': 3.5, 'Estegossauro': 9,
        'Indominus Rex': 15, 'Velociraptor': 2, 'Pyroraptor': 2.5, 'Megalossauro': 9,
        'Triceratops': 9, 'Uhtraraptor': 7, 'Parassaurolofo': 10, 'Carnotauro': 8,
        'Anquilossauro': 6, 'Sinoceratops': 6, 'Paquicefalossauro': 4.5, 'Giganotossauro': 13,
        'Braquiossauro': 22, 'Diplodoco': 26, 'Majungassauro': 8, 'Brontossauro': 22,
        'Tiranossauro Rex': 12, 'Espinossauro': 15
    };
    let size = baseSizes[dinoName] || 5;
    size += (Math.random() - 0.5) * size * 0.15;
    mutations.forEach(m => {
        if (m === 'giant') size *= 1.08;
    });
    return Math.round(size * 100) / 100;
}
function generateLifeExpectancy(dinoName, mutations) {
    let life = 20 + Math.random() * 30;
    mutations.forEach(m => {
        if (m === 'colorful') life *= 0.8;
        if (m === 'diamond') life *= 1.2;
        if (m === 'ruby') life *= 3.6;
    });
    return Math.round(life);
}
function calculateValue(dinoName, mutations, multiplier = 1) {
    let value = dinosaurs[dinoName].price * multiplier;
    mutations.forEach(m => {
        switch(m) {
            case 'golden': value *= 1.05; break;
            case 'giant': value *= 1.15; break;
            case 'colorful': value *= 1.15; break;
            case 'diamond': value *= 1.30; break;
            case 'ruby': value *= 2.13; break;
        }
    });
    value += (Math.random() - 0.5) * value * 0.2;
    return Math.round(value);
}
function generateAppearance(mutations) {
    const appearances = ['Magn√≠fico', 'Imponente', 'Elegante', 'Feroz', 'Majestoso'];
    if (mutations.includes('ruby')) return 'Lend√°rio';
    if (mutations.includes('diamond')) return 'Brilhante';
    if (mutations.includes('colorful')) return 'Deslumbrante';
    if (mutations.includes('golden')) return 'Dourado';
    if (mutations.includes('giant')) return 'Colossal';
    return appearances[Math.floor(Math.random() * appearances.length)];
}


function showInventory(targetData = null) {
    const data = targetData || gameState;
    const isRobbery = !!targetData;
    
    const grid = document.getElementById('inventoryGrid');
    grid.innerHTML = '';
    
    if (data.inventory.length === 0) {
        grid.innerHTML = '<p style="color: white; text-align: center; grid-column: 1/-1;">Nenhum dinossauro no invent√°rio</p>';
    } else {
        data.inventory.forEach((dino, index) => {
            const card = document.createElement('div');
            card.className = 'dino-card';
            
            if(isRobbery) {
                card.onclick = () => selectItemToSteal({type: 'dino', index: index, data: dino}, card);
            } else {
                card.onclick = () => selectDinoForStats(index);
            }
            
            const mutationEmoji = dino.mutations.includes('ruby') ? 'üíé' :
                                dino.mutations.includes('diamond') ? 'üí†' :
                                dino.mutations.includes('golden') ? 'üü®' :
                                dino.mutations.includes('giant') ? 'ü¶£' :
                                dino.mutations.includes('colorful') ? 'üåà' : 'ü¶ï';
            
            card.innerHTML = `
                <div style="font-size: 2rem;">${mutationEmoji}</div>
                <div style="font-weight: bold;">${dino.customName}</div>
                <div style="font-size: 0.8rem;">$${dino.value.toLocaleString()}</div>
            `;
            grid.appendChild(card);
        });
    }
    document.getElementById('inventoryModal').style.display = 'block';
}

function selectDinoForStats(index) {
    gameState.selectedDino = index;
    document.querySelectorAll('.dino-card').forEach(card => card.classList.remove('selected'));
    document.querySelectorAll('.dino-card')[index].classList.add('selected');
}


function showStats() {
    if (gameState.selectedDino === -1) {
        showNotification('Selecione um dinossauro primeiro!', 'error');
        return;
    }
    const dino = gameState.inventory[gameState.selectedDino];
    const age = Math.floor((Date.now() - dino.birthTime) / (1000 * 60 * 60 * 24));
    const statsContent = document.getElementById('statsContent');
    statsContent.innerHTML = `...`; // L√≥gica de stats inalterada
    document.getElementById('statsModal').style.display = 'block';
}


function showCodes() {
    document.getElementById('codeInput').value = '';
    document.getElementById('codesModal').style.display = 'block';
}

function submitCode() {
    const code = document.getElementById('codeInput').value.trim();
    if (gameState.usedCodes.includes(code)) {
        showNotification('C√≥digo j√° foi usado!', 'error');
        return;
    }

    let success = false;
    let notificationMsg = '';

    switch(code) {
        // C√≥digos antigos mantidos
        case '#Spike':
            gameState.money += 2500;
            notificationMsg = 'Voc√™ ganhou $2.500!';
            success = true;
            break;
        
        // Novos C√≥digos
        case 'Flash':
            gameState.activeBoosts.speed = { expires: Date.now() + 1800000 }; // 30 min
            notificationMsg = 'Velocidade de incuba√ß√£o 2x por 30 minutos!';
            success = true;
            break;

        case 'JurassicPark':
            if (Math.random() < 0.5) {
                gameState.money += 1993;
                notificationMsg = 'Voc√™ ganhou $1,993!';
            } else {
                const rexy = createDinoObject('Tiranossauro Rex', [], {
                    customName: 'Rexy',
                    valueMultiplier: 5,
                    isSpecial: true
                });
                gameState.inventory.push(rexy);
                notificationMsg = 'Voc√™ ganhou um T-Rex especial: Rexy!';
            }
            success = true;
            break;

        case 'ReallyReallySpikeCode':
            gameState.money += 5000000;
            const spike = createDinoObject('Espinossauro', ['ruby'], {
                customName: 'Spike',
                isSpecial: true
            });
            gameState.inventory.push(spike);
            notificationMsg = 'Voc√™ ganhou o Espinossauro Rubi "Spike" e $5.000.000!';
            success = true;
            break;
        
        case 'Owen':
            const blue = createDinoObject('Velociraptor', [], {
                customName: 'Blue',
                valueMultiplier: 5,
                isSpecial: true
            });
            gameState.inventory.push(blue);
            notificationMsg = 'Voc√™ ganhou a Velociraptor especial: Blue!';
            success = true;
            break;

        case 'Claire':
            const indominus = createDinoObject('Indominus Rex');
            gameState.inventory.push(indominus);
            notificationMsg = 'Voc√™ ganhou um Indominus Rex!';
            success = true;
            break;

        // C√≥digo de Admin
        case 'BancoADMcr00fhsk':
            showAdminPanel();
            notificationMsg = 'Painel de administrador aberto.';
            success = false; // N√£o marca como "usado"
            break;
            
        default:
            showNotification('C√≥digo inv√°lido!', 'error');
            break;
    }
    
    if (success) {
        gameState.usedCodes.push(code);
        showNotification(notificationMsg, 'success');
        updateMoneyDisplay();
        closeModal('codesModal');
    }
}


function showAdminPanel() {
    closeModal('codesModal');
    const users = JSON.parse(localStorage.getItem('game_users')) || {};
    let content = '<ul>';
    for(const username in users) {
        content += `<li><strong>Usu√°rio:</strong> ${username} - <strong>C√≥digo:</strong> ${users[username]}</li>`;
    }
    content += '</ul>';
    
    // Cria o modal se n√£o existir
    if (!document.getElementById('adminModal')) {
        const modal = document.createElement('div');
        modal.id = 'adminModal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('adminModal')">√ó</button>
                <h2 style="color: white; margin-bottom: 20px;">BANCO DE DADOS DE USU√ÅRIOS</h2>
                <div id="adminContent" style="color: white;"></div>
            </div>
        `;
        document.body.appendChild(modal);
    }

    document.getElementById('adminContent').innerHTML = content;
    document.getElementById('adminModal').style.display = 'block';
}

// ... (todas as outras fun√ß√µes de venda, etc., continuam aqui)
function showSellInterface() { /* ... inalterada ... */ }
function selectDinoForSale(index) { /* ... inalterada ... */ }
function sellRandom() { /* ... inalterada ... */ }
function sellAll() { /* ... inalterada ... */ }
function sellSelected() { /* ... inalterada ... */ }

// =========================================================================
// NOVA MEC√ÇNICA: ROUBO E SEGURAN√áA
// =========================================================================

function showRobberyPrompt() {
    // Cria o modal de roubo se n√£o existir
    if (!document.getElementById('robberyModal')) {
        const modal = document.createElement('div');
        modal.id = 'robberyModal';
        modal.className = 'modal';
        modal.innerHTML = `
            <div class="modal-content">
                <button class="close-btn" onclick="closeModal('robberyModal')">√ó</button>
                <h2 style="color: white; margin-bottom: 20px;">Roubar Jogador</h2>
                <input type="text" id="robberyTargetInput" class="code-input" placeholder="Nome de usu√°rio do alvo">
                <button class="action-button buy-btn" onclick="findRobberyTarget()">PROCURAR ALVO</button>
            </div>
        `;
        document.body.appendChild(modal);
    }
    document.getElementById('robberyModal').style.display = 'block';
}

function findRobberyTarget() {
    const targetUsername = document.getElementById('robberyTargetInput').value.trim();
    if (!targetUsername || targetUsername === currentUser) {
        showNotification("Alvo inv√°lido!", "error");
        return;
    }
    if (gameState.cooldowns.robbery && Date.now() < gameState.cooldowns.robbery) {
        const remaining = Math.ceil((gameState.cooldowns.robbery - Date.now()) / 60000);
        showNotification(`Voc√™ precisa esperar ${remaining} min para roubar de novo.`, 'error');
        return;
    }

    const targetData = loadTargetData(targetUsername);
    if (!targetData) {
        showNotification("Jogador n√£o encontrado.", "error");
        return;
    }

    // Checa se o alvo tem 'Bloqueador'
    if (targetData.activeBoosts.shield && Date.now() < targetData.activeBoosts.shield.expires) {
        showNotification("Este jogador est√° com a seguran√ßa ativa! Imposs√≠vel invadir.", "error");
        gameState.cooldowns.robbery = Date.now() + 600000; // Cooldown de 10 min mesmo na falha
        return;
    }

    closeModal('robberyModal');
    enterRobberyMode(targetUsername, targetData);
}

function enterRobberyMode(targetUsername, targetData) {
    document.body.classList.add('robbery-mode');

    // Esconde bot√µes normais e mostra o de roubo
    document.getElementById('mainGameButtons').style.display = 'none';
    document.getElementById('robberyActionButtons').style.display = 'flex';
    document.getElementById('robberyExitButton').style.display = 'block';

    // Salva o estado atual da UI para restaurar depois
    window.originalUIState = {
        incubators: document.getElementById('incubatorsContainer').innerHTML,
    };
    
    // Mostra os dados do alvo
    updateIncubators(targetData);
    showInventory(targetData); // Mostra o invent√°rio do alvo
    
    document.getElementById('startRobberyBtn').onclick = () => startRobbery(targetUsername, targetData);
}

function exitRobberyMode() {
    document.body.classList.remove('robbery-mode');
    document.getElementById('mainGameButtons').style.display = 'flex';
    document.getElementById('robberyActionButtons').style.display = 'none';
    document.getElementById('robberyExitButton').style.display = 'none';
    
    // Restaura a UI
    updateIncubators();
    closeModal('inventoryModal');
    window.selectedToSteal = null;
}

let selectedToSteal = null;
function selectItemToSteal(item, element) {
    // Remove a sele√ß√£o anterior
    document.querySelectorAll('.incubator.selected, .dino-card.selected').forEach(el => el.classList.remove('selected'));
    
    selectedToSteal = item;
    element.classList.add('selected');
}

function startRobbery(targetUsername, targetData) {
    if (!selectedToSteal) {
        showNotification("Selecione um item para roubar!", "error");
        return;
    }
    
    // L√≥gica de tempo de roubo
    let baseTime = (selectedToSteal.data.price || dinosaurs[selectedToSteal.data.dino].price) / 100;
    baseTime = Math.min(baseTime, 2400000); // Max 40 min

    // Checa se o alvo tem o boost 'Demora'
    if(targetData.activeBoosts.slowdown && Date.now() < targetData.activeBoosts.slowdown.expires) {
        baseTime *= 10;
    }
    
    const endTime = Date.now() + baseTime;

    // Atualiza o estado do ladr√£o
    gameState.robberyStatus.isRobbing = {
        target: targetUsername,
        item: selectedToSteal,
        endTime: endTime
    };
    gameState.cooldowns.robbery = Date.now() + 600000; // 10 min cooldown
    
    // Atualiza o estado da v√≠tima
    targetData.robberyStatus.beingRobbed = {
        robber: currentUser,
        item: selectedToSteal,
        endTime: endTime
    };

    saveGameData();
    saveTargetData(targetUsername, targetData);
    exitRobberyMode();
    showNotification(`Roubo iniciado! Tempo: ${Math.ceil(baseTime / 60000)} minutos.`);
}


function checkRobberyStatus() {
    // Checa se o jogador ATUAL est√° sendo roubado
    if (gameState.robberyStatus.beingRobbed) {
        const robbery = gameState.robberyStatus.beingRobbed;
        if (Date.now() >= robbery.endTime) {
            // Roubo conclu√≠do sem defesa
            showNotification(`Seu item foi roubado por ${robbery.robber}!`, "error");
            gameState.robberyStatus.beingRobbed = null;
        } else {
            // Mostra o alerta de defesa
            if(!document.getElementById('defenseAlert')) {
                const alertDiv = document.createElement('div');
                alertDiv.id = 'defenseAlert';
                alertDiv.style = `...`; // Estilos para o alerta vermelho
                alertDiv.innerHTML = `
                    ALERTA! ${robbery.robber} est√° roubando seu ${robbery.item.data.name || robbery.item.data.dino}!
                    <button onclick="startDefensePuzzle()">DEFENDER!</button>
                `;
                document.body.appendChild(alertDiv);
            }
        }
    } else {
        if(document.getElementById('defenseAlert')) {
            document.getElementById('defenseAlert').remove();
        }
    }
    
    // Checa se o jogador ATUAL completou um roubo
    if (gameState.robberyStatus.isRobbing) {
        const robbery = gameState.robberyStatus.isRobbing;
        if (Date.now() >= robbery.endTime) {
            finalizeRobbery(robbery);
        }
    }
}

function finalizeRobbery(robbery) {
    const targetData = loadTargetData(robbery.target);
    // Checa se o roubo ainda √© v√°lido (v√≠tima pode ter defendido)
    if (!targetData.robberyStatus.beingRobbed) {
        showNotification(`O roubo contra ${robbery.target} falhou!`, 'error');
        gameState.robberyStatus.isRobbing = null;
        return;
    }

    let stolenItem;
    // Checa se a v√≠tima tem o boost 'Falso'
    if (targetData.activeBoosts.decoy && Date.now() < targetData.activeBoosts.decoy.expires) {
        stolenItem = createDinoObject('Compsognato', [], {customName: "Isca"});
        showNotification("Voc√™ roubou uma isca! Ganhou um Compsognato.", "success");
    } else {
        if(robbery.item.type === 'egg') {
             // Por simplicidade, ovos s√£o convertidos em dinos ao serem roubados
            stolenItem = createDinoObject(robbery.item.data.dino, robbery.item.data.mutations);
            targetData.incubators[robbery.item.index] = null;
        } else {
            stolenItem = robbery.item.data;
            targetData.inventory.splice(robbery.item.index, 1);
        }
        showNotification(`Roubo contra ${robbery.target} bem-sucedido!`, "success");
    }
    
    gameState.inventory.push(stolenItem);
    gameState.robberyStatus.isRobbing = null;
    targetData.robberyStatus.beingRobbed = null;

    saveGameData();
    saveTargetData(robbery.target, targetData);
}

let defensePuzzle = {};
function startDefensePuzzle() {
    // Gera um puzzle de sequ√™ncia num√©rica simples
    const start = Math.floor(Math.random() * 10) + 1;
    const step = Math.floor(Math.random() * 5) + 2;
    const sequence = [start, start + step, start + (2 * step)];
    const answer = start + (3 * step);

    defensePuzzle = {
        answer: answer,
        attempts: 3
    };

    // Cria modal do puzzle
    // ... (c√≥digo para criar o modal com o prompt e input)
    // Ex: prompt(`Qual o pr√≥ximo n√∫mero na sequ√™ncia: ${sequence.join(', ')} ? Voc√™ tem 3 tentativas.`)
}

// ... (Fun√ß√µes para checar a resposta do puzzle e concluir a defesa)


// =========================================================================
// FUN√á√ïES UTILIT√ÅRIAS E DE UI (MODAIS, NOTIFICA√á√ïES)
// =========================================================================

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    notification.textContent = message;
    notification.className = `notification ${type}`;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 4000);
}

function closeModal(modalId) {
    const modal = document.getElementById(modalId);
    if (modal) {
        modal.style.display = 'none';
        if (modalId === 'shopModal' && shopTimerInterval) {
            clearInterval(shopTimerInterval);
        }
    }
}

    </script>
</body>
</html>
